name: Deploy React App

on:
  push:
    branches:
      - main  # 只有當 code 合併到 main 分支時才執行

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. 複製 GitHub 上的程式碼到 Runner 環境
      - name: Checkout Code
        uses: actions/checkout@v4

      # 2. 設定 Node.js 環境（確保 build 的環境穩定）
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      # 3. 安裝依賴並執行 Build
      - name: Install & Build
        run: |
          npm install
          npm run build
        # 注意：如果你的 React 是 Vite 建立的，產出資料夾通常叫 dist/
        # 如果是舊版 Create React App 則是 build/
        # 請確認你的 build 產出資料夾名稱

      # 4. 透過 SCP (安全傳輸協定) 把檔案丟進 VM
      - name: Copy files to GCP VM
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VM_IP }}
          username: ${{ secrets.REACT_TEST_VM_USERNAME }}
          key: ${{ secrets.REACT_TEST_VM }}
          source: "dist/*"   # 這裡填寫你 build 出來的資料夾名稱 (e.g., dist/* 或 build/*)
          target: "/var/www/html"
          strip_components: 1 # 重要！這會去掉 dist/ 目錄本身，只傳送裡面的內容
